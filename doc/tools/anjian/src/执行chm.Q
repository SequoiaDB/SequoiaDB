[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=0
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=9b709989-e803-4c0e-8029-744abe0fc91a
Description=执行chm
Enable=1
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=2
QUI=
[Relative]
SetupOCXFile=
[Comment]

[Attachment]
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


[Script]
LogStart "./anjian.log"

Dim filename, config_path, result, maxX, maxY

//获取屏幕宽高
maxX = Plugin.Sys.GetScRX()
maxY = Plugin.Sys.GetScRY()

TracePrint "Event: 分辨率:" & maxX & " * " & maxY

Call init()

result = exec()

If result = False Then 
	TracePrint "Error: Failed to build chm."
Else 
	TracePrint "Event: Success to build chm."
End If

LogStop

Call closeSelf()

EndScript


//初始化
Function init()

	TracePrint "Event: start init"

    Dim handle
    
    TracePrint "Event: Find winCHM"
    
    handle = isStartwinCHM(1)
    If handle > 0 Then 
        TracePrint "Warning: winCHM is running, close it."
        Plugin.Window.CloseEx handle
    End If
    //读取配置
    config_path = Plugin.File.ReadINI("config", "path", "./config.ini")
    filename = Plugin.File.ReadINI("config", "file", "./config.ini")
    
    TracePrint "Event: Get config path: " + config_path
    
End Function

//执行任务
Function exec()

	TracePrint "Event: start task"

    Dim handle, result

    If config_path = "" Then 
    	
        TracePrint "Error: No such config file or config value."
    	
        exec = False
    	
        Exit Function
    	
    End If

    //执行winCHM
    RunApp config_path
    
    TracePrint "Event: start winCHM"
	
    //等待winCHM执行起来
    handle = isStartwinCHM(500)
    If handle = 0 Then 
        TracePrint "Error: Failed to start winCHM."
        exec = False
        Exit Function
    End If
	
    Delay 1000
	
    //隐藏窗口
    Call Plugin.Window.Hide(handle)
	
    Delay 1000
    
    result = build(handle)
    If result = False Then 
    	
    	exec = False
    	
    	TracePrint "Error: Failed to build chm."
    	
    	Plugin.Window.CloseEx handle
    	
    	Exit Function
    	
    End If
    
    TracePrint "Event: End of build, close winCHM"
    
    Plugin.Window.CloseEx handle
	
    exec = True
	
End Function

Function build(handle)

	TracePrint "Event: Start build chm"
	
	Delay 5000

    Dim x, y, left, top, result, subHandle, sText, pos, HwndEx
    
    Delay 200
	
	//对窗口按下F9,打开编译窗口
    Call Plugin.Window.SendKeyPress(handle, 120)
       
    TracePrint "Event: Click build button."
       
    Delay 3000
    
    //查找编译窗口
    subHandle = Plugin.Window.Find("TfrmCompiler", "Build help file")
    If subHandle = 0 Then 
    	
    	build = False
    	
    	TracePrint "Error: Failed to find title is 'build help file' windows."
    	
    	Exit Function
    	
    End If
    
    Delay 200
    
	//对编译窗口按下enter
    Call Plugin.Window.SendKeyPress(subHandle, 13)
    
    TracePrint "Event: Click start button."
    
    Delay 8000
       
    TracePrint "Event: Wait for building windows."
    
    subHandle = Plugin.Window.Find("TfrmOutput", "Building")
    If subHandle = 0 Then 
    	
    	build = False
    	
    	TracePrint "Error: Failed to find title is 'Building' windows."
    	
    	Exit Function
    	
    End If
    
    TracePrint "Event: Building chm..."
    
    TracePrint subHandle
       
    Delay 200
    
    pos = -1
    
    Do While pos <= 0
    
    	HwndEx = Plugin.Window.FindEx(subHandle, 0, "TMemo", "")

		sText = Plugin.Window.GetTextEx(HwndEx, 1)
    	
    	//TracePrint sText
    	
    	pos = InStrRev(sText, "Completed.")
    	
    	//TracePrint pos
    	
    	Delay 1000
    
    Loop
    
    Delay 5000
    
    TracePrint "Event: build chm complete."
    
	build = True
	
End Function

/*
判断winCHM是否在运行 
tryCount 重试次数
return   返回winCHM的窗口句柄
*/
Function isStartwinCHM( tryCount )
	
    Dim num, handle, tryNum
	
    num = 0
    tryNum = 0
	
    isStartwinCHM = 0
	
    Do while tryNum <= tryCount
        handle = Plugin.Window.Find("TfrmMain", "WinCHM Pro v4.35 - " & filename)
        If handle > 0 Then 
            isStartwinCHM = handle
            Exit Do
        End If
        Delay 600
        tryNum = tryNum + 1
    Loop
    
End Function


Function closeSelf()
	
	Hwnd = Plugin.Window.Find(0, "autoBuildCHM - qwertyuiop123")
	If Hwnd > 0 Then
		Call Plugin.Window.CloseEx(Hwnd)
	End If
	
End Function