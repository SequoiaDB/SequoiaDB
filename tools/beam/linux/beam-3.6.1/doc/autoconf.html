<html>
<head>
  <title>BEAM: Makefiles Generated by Configure</title>
  <link rel="stylesheet" href="style.css" type="text/css" />
</head>
<body>

<div id="wrap">

<table class="center">

<td id="left">
  <img src="images/logo.png" /><br />
  <ul id="navlist">
    <li id="navtitle">Information</li>
    <li><a href="whatis.html">What is BEAM</a></li>
    <li><a href="impatient.html">BEAM for the Impatient</a></li>
    <li><a href="links.html">Links</a></li>
    <li><a href="myths.html">Myths</a></li>
    <li><a href="index.html">Home</a></li>
    <li><a href="sitemap.html">Sitemap</a></li>

    <li id="navtitle">New Stuff</li>
    <li><a href="beam_trace.html">Build Tracing</a></li>
    <li><a href="windows.html">Windows Port</a></li>
    <li><a href="java.html">Java Support</a></li>
    <li><a href="eclipse/index.html">Eclipse Plug-in</a></li>

    <li id="navtitle">Releases</li>
    <li><a href="install.html">Download</a></li>
    <li><a href="schedule.html">Schedule</a></li>
    <li><a href="history.html">History</a></li>

    <li id="navtitle">Documentation</li>
    <li><a href="quick.html">Quick start guide</a></li>
    <li><a href="install.html">Installation Instructions</a></li>
    <li><a href="customize.html">BEAM Customization</a></li>
    <li><a href="compilers.html">Compiler Emulation</a></li>
    <li><a href="build.html">Build Integration Guide</a></li>
    <li><a href="builtin.html">Built-in Checks</a></li>
    <li><a href="parms.html">Built-in Parameters </a></li>
    <li><a href="attributes.html">Function Attributes</a></li>
    <li><a href="reference.html">Reference Docs</a></li>
    <li><a href="appnotes.html">Application Notes</a></li>
    <li><a href="faq.html">FAQ</a>

    <li id="navtitle">Contact</li>
    <li><a href="mailing-lists.html">Mailing Lists</a></li>
    <li><a href="http://spacedog.fishkill.ibm.com/beambugz/bugreport.cgi">Report a bug</a></li>
  </ul>
</td>

<td id="right">
<p>

</p>
<p>

</p>
<p>
<h1 class="title">Running BEAM Using Makefiles Generated by Configure</h1>
<hr/>

</p>
<p>
This application note describes how to run BEAM on software that is 
built using Makefiles generated by 
<a href="http://www.gnu.org/software/autoconf/"><span class="command">configure</span></a>.
</p>
<p>
Such Makefiles use the variables <span class="var">CC</span> and <span class="var">CXX</span> 
to point to the C and C++ compilers, respectively. 
We overwrite those variables such that instead of pointing to the
compilers they now point to shell scripts <span class="command">runbeam-c</span>
and <span class="command">runbeam-cxx</span>
which in turn will invoke BEAM. Like so (for Bourne shell):
</p>
<pre class="example">
export CC=/someplace/runbeam-c
export CXX=/someplace/runbeam-cxx
export LIBTOOL='\$(SHELL) \$(top_builddir)/libtool --tag=CXX'
make -e
</pre>
<p>

This is convenient because the Makefile itself (or any of the files it
was generated from) does not need to be changed. 
Whatever shell you use, make sure to use a subshell and <span class="strong">not</span>
redefine CC/CXX in your environment. 
</p>
<p>
Since Makefiles typically do all kinds of other things in addition to
invoking the compiler, it will be necessary to emulate a regular 
<span class="term">make</span> when invoking BEAM. Therefore, the <span class="command">runbeam-c</span> script 
will invoke both the compiler and BEAM. It is important that the BEAM
invocation does not generate any output, so we redirect parser messages
and BEAM complaints to some files. 
</p>
<p>
However, for some compiler invocations you will not want to run BEAM.
For instance, when the compiler is used to preprocess some 
file (<span class="option">-E</span>).
In addition, when <span class="command">configure</span> runs as part of your build, the
compiler will get invoked numerous times to determine absence/presence
of features if the build environment. There is no point of running
BEAM here. Therefore, we recommend that at the end of your
<span class="file">configure.in</span> (or <span class="file">configure.ac</span>) you add these
lines:
</p>
<pre class="example">
CC_IN_CONFIGURE=yes 
export CC_IN_CONFIGURE
</pre>
<p>

The <span class="command">runbeam-c</span> script will then do the right thing. Here it comes:
</p>
<pre class="example">
#!/bin/sh

#
# Define some variables (adjust to your needs)
#
BP=&quot;parser-messages&quot;
BC=&quot;BEAM-complaints&quot;
OLD_CC=gcc

# Path to BEAM executable
BEAM_COMPILE=&quot;/full/path/to/beam/bin/beam_compile&quot;

# Path to compiler configuration files for C and C++
BEAM_C_CONFIG=&quot;/full/path/to/gcc.tcl&quot;
BEAM_CPP_CONFIG=&quot;/full/path/to/g++.tcl&quot;

#
# Was -E given
#
E_seen=0

#
# Was a source file given
#
S_seen=0

case &quot;$CC_IN_CONFIGURE&quot; in
  yes)   E_seen=1;;
esac

for opt in &quot;$@&quot;
do
  case &quot;$opt&quot; in
    -E) E_seen=1;;
    *.c | *.C | *.cpp | *.CPP | *.cxx | *.cc) S_seen=1;;
  esac
done

#
# Invoke BEAM
#
if [ $E_seen = 0 -a $S_seen = 1 ]; then
  $BEAM_COMPILE -c --beam::exit0 --beam::parser_file=$BP --beam::complaint_file=$BC \
                --beam::compiler=$BEAM_C_CONFIG --beam::compiler=$BEAM_CPP_CONFIG \
                &quot;$@&quot; 2&gt;&gt; MISC_ERRORS
fi

#
# Invoke compiler
#
$OLD_CC &quot;$@&quot;
</pre>
<p>

The <span class="command">runbeam-cxx</span> is not shown. It only differs in the value 
that is assigned to <span class="var">OLD_CC</span>.
Note, that we invoke BEAM first. That way, the make process will see the same
return codes as in a native "make" run.
You will have to define the variables <span class="var">BP</span>, <span class="var">BC</span>,
<span class="var">BEAM_COMPILE</span>, <span class="var">BEAM_C_CONFIG</span>, 
<span class="var">BEAM_CPP_CONFIG</span>, and <span class="var">OLD_CC</span>
according to your needs.
</p>

</td>

</table>

</div>

</body>
</html>
